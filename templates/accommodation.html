<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Accommodation Management | TLCS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Delius&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') }}">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-text">
                    <div class="logo-title">TANZANIA LABOUR</div>
                    <div class="logo-collection">COLLEGE</div>
                    <div class="logo-subtitle">E-mail: labourtz@gmail.com</div>
                    <div class="logo-subtitle">P.O.Box 3454</div>
                    <div class="logo-subtitle">MBEYA-TANZANIA</div>
                </div>
                <div class="logo-condensed">TLC</div>
            </div>
            <div class="menu">
                <div class="menu-item" onclick="location.href='{{ url_for('admin_dashboard') }}';">
                    <i class="fas fa-home"></i>
                    <span class="menu-text">Dashboard</span>
                </div>
                <div class="menu-item" onclick="location.href='{{ url_for('admin_students') }}';">
                    <i class="fas fa-user-graduate"></i>
                    <span class="menu-text">Students</span>
                </div>
                <div class="menu-item" onclick="location.href='{{ url_for('admin_lecturers') }}';">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span class="menu-text">Lecturers</span>
                </div>
                <div class="menu-item" onclick="location.href='{{ url_for('admin_courses') }}';">
                    <i class="fas fa-book"></i>
                    <span class="menu-text">Courses</span>
                </div>
                <div class="menu-item" onclick="location.href='{{ url_for('admin_programs') }}';">
                    <i class="fas fa-clipboard-list"></i>
                    <span class="menu-text">Programs</span>
                </div>
                <div class="menu-item" onclick="location.href='{{ url_for('admin_results') }}';">
                    <i class="fas fa-chart-bar"></i>
                    <span class="menu-text">Results</span>
                </div>
                <div class="menu-item" onclick="location.href='{{ url_for('admin_assessments') }}';">
                    <i class="fas fa-clipboard-list"></i>
                    <span class="menu-text">Assessments</span>
                </div>
                <div class="menu-item" onclick="location.href='{{ url_for('admin_payments') }}';">
                    <i class="fas fa-money-bill-wave"></i>
                    <span class="menu-text">Payments</span>
                </div>
                <div class="menu-item active" onclick="location.href='{{ url_for('admin_accommodations') }}';">
                    <i class="fas fa-bed"></i>
                    <span class="menu-text">Accommodations</span>
                </div>
                <div class="menu-item" onclick="location.href='{{ url_for('admin_settings') }}';">
                    <i class="fas fa-cog"></i>
                    <span class="menu-text">Settings</span>
                </div>
                <div class="menu-item" onclick="location.href='{{ url_for('login') }}';">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="menu-text">Logout</span>
                </div>
            </div>
        </div>
        <!-- Main Content -->
        <div class="main-content" id="main-content">
            <div class="header">
                <div class="header-left">
                    <button class="toggle-btn" id="toggle-sidebar" title="Collapse/Expand">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="breadcrumbs">Accommodation / Management</div>
                </div>
                <h1>Accommodation Management</h1>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" id="add-accommodation-btn"><i class="fas fa-plus-circle"></i> Add Hostel/Room</button>
                <button class="btn btn-primary" id="allocate-room-btn"><i class="fas fa-user-plus"></i> Allocate Room</button>
            </div>
            <!-- Add/Edit Hostel or Room Section -->
            <div class="add-section" id="add-accommodation-section">
                <h3>Add/Edit Hostel or Room</h3>
                <form id="accommodation-form">
                    <div class="add-grid">
                        <div class="form-group">
                            <label for="accommodation-type"><i class="fas fa-building"></i> Type *</label>
                            <select class="form-control" id="accommodation-type" required>
                                <option value="">Select Type</option>
                                <option value="hostel">Hostel</option>
                                <option value="room">Room</option>
                            </select>
                            <div class="error-message" id="accommodation-type-error">Type is required</div>
                        </div>
                        <div class="form-group hostel-field">
                            <label for="hostel-name"><i class="fas fa-building"></i> Hostel Name *</label>
                            <input type="text" class="form-control" id="hostel-name" placeholder="Enter hostel name">
                            <div class="error-message" id="hostel-name-error">Hostel name is required</div>
                        </div>
                        <div class="form-group hostel-field">
                            <label for="hostel-capacity"><i class="fas fa-users"></i> Hostel Capacity *</label>
                            <input type="number" class="form-control" id="hostel-capacity" min="1" placeholder="Enter capacity">
                            <div class="error-message" id="hostel-capacity-error">Capacity must be greater than 0</div>
                        </div>
                        <div class="form-group room-field" style="display: none;">
                            <label for="room-hostel"><i class="fas fa-building"></i> Hostel *</label>
                            <select class="form-control" id="room-hostel">
                                <option value="">Select Hostel</option>
                            </select>
                            <div class="error-message" id="room-hostel-error">Hostel is required</div>
                        </div>
                        <div class="form-group room-field" style="display: none;">
                            <label for="room-number"><i class="fas fa-door-open"></i> Room Number *</label>
                            <input type="text" class="form-control" id="room-number" placeholder="Enter room number">
                            <div class="error-message" id="room-number-error">Room number is required</div>
                        </div>
                        <div class="form-group room-field" style="display: none;">
                            <label for="room-capacity"><i class="fas fa-users"></i> Room Capacity *</label>
                            <input type="number" class="form-control" id="room-capacity" min="1" placeholder="Enter capacity">
                            <div class="error-message" id="room-capacity-error">Capacity must be greater than 0</div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancel-accommodation-btn">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="save-accommodation-btn">Save</button>
                    </div>
                </form>
            </div>
            <!-- Allocate Room Section -->
            <div class="allocate-section" id="allocate-room-section">
                <h3>Allocate Room</h3>
                <form id="allocation-form">
                    <div class="allocate-grid">
                        <div class="form-group">
                            <label for="allocate-student"><i class="fas fa-user-graduate"></i> Student *</label>
                            <select class="form-control" id="allocate-student" required>
                                <option value="">Select Student</option>
                            </select>
                            <div class="error-message" id="allocate-student-error">Student is required</div>
                        </div>
                        <div class="form-group">
                            <label for="allocate-hostel"><i class="fas fa-building"></i> Hostel *</label>
                            <select class="form-control" id="allocate-hostel" required>
                                <option value="">Select Hostel</option>
                            </select>
                            <div class="error-message" id="allocate-hostel-error">Hostel is required</div>
                        </div>
                        <div class="form-group">
                            <label for="allocate-room"><i class="fas fa-door-open"></i> Room *</label>
                            <select class="form-control" id="allocate-room" required>
                                <option value="">Select Room</option>
                            </select>
                            <div class="error-message" id="allocate-room-error">Room is required</div>
                        </div>
                        <div class="form-group">
                            <label for="start-date"><i class="fas fa-calendar-alt"></i> Start Date *</label>
                            <input type="date" class="form-control" id="start-date" required>
                            <div class="error-message" id="start-date-error">Start date is required</div>
                        </div>
                        <div class="form-group">
                            <label for="end-date"><i class="fas fa-calendar-alt"></i> End Date *</label>
                            <input type="date" class="form-control" id="end-date" required>
                            <div class="error-message" id="end-date-error">End date must be after start date</div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancel-allocation-btn">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="save-allocation-btn">Save Allocation</button>
                    </div>
                </form>
            </div>
            <!-- Overview Cards -->
            <div class="cards">
                <div class="card">
                    <div class="card-title">Total Hostels</div>
                    <div class="card-value" id="kpi-hostels">0</div>
                </div>
                <div class="card">
                    <div class="card-title">Total Rooms</div>
                    <div class="card-value" id="kpi-rooms">0</div>
                </div>
                <div class="card">
                    <div class="card-title">Occupied Rooms</div>
                    <div class="card-value" id="kpi-occupied">0</div>
                </div>
                <div class="card">
                    <div class="card-title">Available Rooms</div>
                    <div class="card-value" id="kpi-available">0</div>
                </div>
            </div>
            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" data-tab="hostels">Hostels</div>
                <div class="tab" data-tab="rooms">Rooms</div>
                <div class="tab" data-tab="allocations">Allocations</div>
            </div>
            <!-- Hostels Tab -->
            <div class="tab-content" id="hostels-tab">
                <div class="filter-section">
                    <h3>Filter Hostels</h3>
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label for="hostels-hostel-filter"><i class="fas fa-building"></i> Hostel</label>
                            <select class="filter-control" id="hostels-hostel-filter">
                                <option value="">All Hostels</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="hostels-status-filter"><i class="fas fa-info-circle"></i> Status</label>
                            <select class="filter-control" id="hostels-status-filter">
                                <option value="">All Statuses</option>
                                <option value="Available">Available</option>
                                <option value="Partially Occupied">Partially Occupied</option>
                                <option value="Full">Full</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="hostels-date-range-filter"><i class="fas fa-calendar"></i> Date Range</label>
                            <select class="filter-control" id="hostels-date-range-filter">
                                <option value="">All Time</option>
                                <option value="This Week">This Week</option>
                                <option value="This Month">This Month</option>
                                <option value="This Semester">This Semester</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="hostels-search"><i class="fas fa-search"></i> Search</label>
                            <input type="text" class="filter-control" id="hostels-search" placeholder="Search by hostel ID or name">
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-secondary" id="hostels-reset-filters">Reset Filters</button>
                        <button class="btn btn-primary" id="hostels-apply-filters">Apply Filters</button>
                    </div>
                </div>
                <div class="table-wrap">
                    <table id="hostels-table">
                        <thead>
                            <tr>
                                <th>Hostel ID</th>
                                <th>Hostel Name</th>
                                <th>Capacity</th>
                                <th>Occupied</th>
                                <th>Available</th>
                                <th>Occupancy Rate</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div class="pagination" id="hostels-pagination"></div>
                </div>
            </div>
            <!-- Rooms Tab -->
            <div class="tab-content" id="rooms-tab" style="display: none;">
                <div class="filter-section">
                    <h3>Filter Rooms</h3>
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label for="rooms-hostel-filter"><i class="fas fa-building"></i> Hostel</label>
                            <select class="filter-control" id="rooms-hostel-filter">
                                <option value="">All Hostels</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="rooms-status-filter"><i class="fas fa-info-circle"></i> Status</label>
                            <select class="filter-control" id="rooms-status-filter">
                                <option value="">All Statuses</option>
                                <option value="Available">Available</option>
                                <option value="Partially Occupied">Partially Occupied</option>
                                <option value="Full">Full</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="rooms-date-range-filter"><i class="fas fa-calendar"></i> Date Range</label>
                            <select class="filter-control" id="rooms-date-range-filter">
                                <option value="">All Time</option>
                                <option value="This Week">This Week</option>
                                <option value="This Month">This Month</option>
                                <option value="This Semester">This Semester</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="rooms-search"><i class="fas fa-search"></i> Search</label>
                            <input type="text" class="filter-control" id="rooms-search" placeholder="Search by room ID or number">
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-secondary" id="rooms-reset-filters">Reset Filters</button>
                        <button class="btn btn-primary" id="rooms-apply-filters">Apply Filters</button>
                    </div>
                </div>
                <div class="table-wrap">
                    <table id="rooms-table">
                        <thead>
                            <tr>
                                <th>Room ID</th>
                                <th>Hostel</th>
                                <th>Room Number</th>
                                <th>Capacity</th>
                                <th>Occupied</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div class="pagination" id="rooms-pagination"></div>
                </div>
            </div>
            <!-- Allocations Tab -->
            <div class="tab-content" id="allocations-tab" style="display: none;">
                <div class="filter-section">
                    <h3>Filter Allocations</h3>
                    <div class="filter-grid">
                        <div class="filter-group">
                            <label for="allocations-hostel-filter"><i class="fas fa-building"></i> Hostel</label>
                            <select class="filter-control" id="allocations-hostel-filter">
                                <option value="">All Hostels</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="allocations-status-filter"><i class="fas fa-info-circle"></i> Status</label>
                            <select class="filter-control" id="allocations-status-filter">
                                <option value="">All Statuses</option>
                                <option value="Active">Active</option>
                                <option value="Pending">Pending</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="allocations-student-filter"><i class="fas fa-user-graduate"></i> Student</label>
                            <select class="filter-control" id="allocations-student-filter">
                                <option value="">All Students</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="allocations-date-range-filter"><i class="fas fa-calendar"></i> Date Range</label>
                            <select class="filter-control" id="allocations-date-range-filter">
                                <option value="">All Time</option>
                                <option value="This Week">This Week</option>
                                <option value="This Month">This Month</option>
                                <option value="This Semester">This Semester</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="allocations-search"><i class="fas fa-search"></i> Search</label>
                            <input type="text" class="filter-control" id="allocations-search" placeholder="Search by allocation ID or student">
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-secondary" id="allocations-reset-filters">Reset Filters</button>
                        <button class="btn btn-primary" id="allocations-apply-filters">Apply Filters</button>
                    </div>
                </div>
                <div class="table-wrap">
                    <table id="allocations-table">
                        <thead>
                            <tr>
                                <th>Allocation ID</th>
                                <th>Student</th>
                                <th>Hostel</th>
                                <th>Room</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div class="pagination" id="allocations-pagination"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Accommodation Details Modal -->
    <div class="modal" id="accommodation-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="accommodation-modal-title"></div>
                <button class="close-modal" id="accommodation-details-close" aria-label="Close modal">&times;</button>
            </div>
            <div class="accommodation-profile">
                <div class="accommodation-header">
                    <div class="accommodation-icon">
                        <i class="fas fa-bed"></i>
                    </div>
                    <div>
                        <div class="accommodation-title" id="accommodation-profile-id"></div>
                        <div style="font-size: 0.9rem; opacity: 0.9;" id="accommodation-profile-name"></div>
                    </div>
                </div>
                <div class="accommodation-grid" id="accommodation-profile-grid"></div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" id="details-close-btn">Close</button>
                <button class="btn btn-primary" id="print-btn">Print</button>
                <button class="btn btn-warning" id="edit-btn" style="display: none;">Edit</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Mock data
            const students = [
                { id: 'STU001', name: 'Juma Mohamed', email: 'juma.mohamed@example.com' },
                { id: 'STU002', name: 'Neema Charles', email: 'neema.charles@example.com' },
                { id: 'STU003', name: 'Rajab Abasi', email: 'rajab.abasi@example.com' },
                { id: 'STU004', name: 'Fatuma Hassan', email: 'fatuma.hassan@example.com' }
            ];

            let hostels = [
                { id: 'HST001', name: 'Hostel A', capacity: 100 },
                { id: 'HST002', name: 'Hostel B', capacity: 80 },
                { id: 'HST003', name: 'Hostel C', capacity: 120 }
            ];

            let rooms = [
                { id: 'RM001', hostelId: 'HST001', number: 'A101', capacity: 4 },
                { id: 'RM002', hostelId: 'HST001', number: 'A102', capacity: 4 },
                { id: 'RM003', hostelId: 'HST002', number: 'B201', capacity: 2 }
            ];

            let allocations = [
                { id: 'ALC001', studentId: 'STU001', hostelId: 'HST001', roomId: 'RM001', startDate: '2025-08-01', endDate: '2026-05-31', status: 'Active' },
                { id: 'ALC002', studentId: 'STU002', hostelId: 'HST001', roomId: 'RM001', startDate: '2025-08-01', endDate: '2026-05-31', status: 'Active' }
            ];

            // Populate dropdowns
            const populateDropdowns = () => {
                console.log('Populating dropdowns with hostels:', hostels, 'students:', students, 'rooms:', rooms);
                const hostelSelects = [document.getElementById('room-hostel'), document.getElementById('hostels-hostel-filter'), document.getElementById('rooms-hostel-filter'), document.getElementById('allocate-hostel'), document.getElementById('allocations-hostel-filter')];
                const studentSelects = [document.getElementById('allocate-student'), document.getElementById('allocations-student-filter')];
                const roomSelect = document.getElementById('allocate-room');

                hostelSelects.forEach(select => {
                    select.innerHTML = '<option value="">Select Hostel</option>';
                    hostels.forEach(h => {
                        const option = document.createElement('option');
                        option.value = h.id;
                        option.textContent = h.name;
                        select.appendChild(option);
                    });
                });

                studentSelects.forEach(select => {
                    select.innerHTML = '<option value="">Select Student</option>';
                    students.forEach(s => {
                        const option = document.createElement('option');
                        option.value = s.id;
                        option.textContent = s.name;
                        select.appendChild(option);
                    });
                });

                roomSelect.innerHTML = '<option value="">Select Room</option>';
                rooms.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r.id;
                    option.textContent = `${r.number} (${hostels.find(h => h.id === r.hostelId)?.name || 'N/A'})`;
                    option.dataset.hostelId = r.hostelId;
                    roomSelect.appendChild(option);
                });
            };

            // Update KPIs
            function updateKPIs() {
                const totalHostels = hostels.length;
                const totalRooms = rooms.length;
                const occupiedRooms = rooms.filter(r => allocations.some(a => a.roomId === r.id && a.status === 'Active')).length;
                const availableRooms = totalRooms - occupiedRooms;
                document.getElementById('kpi-hostels').textContent = totalHostels;
                document.getElementById('kpi-rooms').textContent = totalRooms;
                document.getElementById('kpi-occupied').textContent = occupiedRooms;
                document.getElementById('kpi-available').textContent = availableRooms;
            }

            // Pagination
            function paginate(items, perPage, onSlice, pagerEl) {
                let page = 1;
                const total = Math.max(1, Math.ceil(items.length / perPage));
                function renderPager() {
                    pagerEl.innerHTML = '';
                    for (let i = 1; i <= total; i++) {
                        const b = document.createElement('button');
                        b.className = 'pagination-btn' + (i === page ? ' active' : '');
                        b.textContent = i;
                        b.onclick = () => { page = i; slice(); renderPager(); };
                        pagerEl.appendChild(b);
                    }
                }
                function slice() {
                    const start = (page - 1) * perPage;
                    console.log('Paginating items:', items.slice(start, start + perPage));
                    onSlice(items.slice(start, start + perPage));
                }
                slice();
                renderPager();
            }

            // Filter items
            function filterItems(items, prefix, type) {
                console.log('Filtering items:', items, 'Prefix:', prefix, 'Type:', type);
                const hostel = document.getElementById(`${prefix}-hostel-filter`)?.value || '';
                const status = document.getElementById(`${prefix}-status-filter`)?.value || '';
                const student = document.getElementById(`${prefix}-student-filter`)?.value || '';
                const dateRange = document.getElementById(`${prefix}-date-range-filter`)?.value || '';
                const search = document.getElementById(`${prefix}-search`)?.value.toLowerCase() || '';
                const today = new Date();
                let dateFilter = () => true;
                if (type === 'allocations' && dateRange) {
                    if (dateRange === 'This Week') {
                        const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
                        dateFilter = item => new Date(item.startDate || '2025-01-01') >= weekStart;
                    } else if (dateRange === 'This Month') {
                        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                        dateFilter = item => new Date(item.startDate || '2025-01-01') >= monthStart;
                    } else if (dateRange === 'This Semester') {
                        const semesterStart = new Date(today.getFullYear(), today.getMonth() - (today.getMonth() % 6), 1);
                        dateFilter = item => new Date(item.startDate || '2025-01-01') >= semesterStart;
                    }
                }
                return items.filter(item => {
                    const name = type === 'allocations' ? students.find(s => s.id === item.studentId)?.name.toLowerCase() || '' : (item.name || item.number || '').toLowerCase();
                    const itemStatus = type !== 'allocations' ? (
                        type === 'hostels' ? 
                            (item.capacity === 0 ? 'Full' : 
                             allocations.filter(a => a.hostelId === item.id && a.status === 'Active').length === item.capacity ? 'Full' : 
                             allocations.filter(a => a.hostelId === item.id && a.status === 'Active').length === 0 ? 'Available' : 'Partially Occupied') :
                            (allocations.filter(a => a.roomId === item.id && a.status === 'Active').length === 0 ? 'Available' : 
                             allocations.filter(a => a.roomId === item.id && a.status === 'Active').length >= item.capacity ? 'Full' : 'Partially Occupied')
                    ) : item.status;
                    return (!hostel || item.hostelId === hostel || item.id === hostel) &&
                           (!status || itemStatus === status) &&
                           (!student || item.studentId === student) &&
                           (!search || item.id.toLowerCase().includes(search) || name.includes(search)) &&
                           dateFilter(item);
                });
            }

            // Render tables
            function renderHostels() {
                console.log('Rendering hostels with data:', filterItems(hostels, 'hostels', 'hostels'));
                const data = filterItems(hostels, 'hostels', 'hostels');
                const tbody = document.querySelector('#hostels-table tbody');
                const pager = document.getElementById('hostels-pagination');
                paginate(data, 5, slice => {
                    console.log('Hostel slice:', slice);
                    tbody.innerHTML = slice.map(h => {
                        const occupied = allocations.filter(a => a.hostelId === h.id && a.status === 'Active').length;
                        const available = h.capacity - occupied;
                        const occupancyRate = h.capacity ? ((occupied / h.capacity) * 100).toFixed(1) : 0;
                        const status = available === 0 ? 'Full' : available === h.capacity ? 'Available' : 'Partially Occupied';
                        return `
                            <tr data-hostel-id="${h.id}">
                                <td>${h.id}</td>
                                <td>${h.name}</td>
                                <td>${h.capacity}</td>
                                <td>${occupied}</td>
                                <td>${available}</td>
                                <td>${occupancyRate}%</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-info" data-view="${h.id}" data-type="hostel"><i class="fas fa-eye"></i> View</button>
                                        <button class="btn btn-sm btn-warning" data-edit="${h.id}" data-type="hostel"><i class="fas fa-edit"></i> Edit</button>
                                        <button class="btn btn-sm btn-danger" data-delete="${h.id}" data-type="hostel"><i class="fas fa-trash"></i> Delete</button>
                                    </div>
                                </td>
                            </tr>`;
                    }).join('');
                    bindActions();
                }, pager);
            }

            function renderRooms() {
                console.log('Rendering rooms with data:', filterItems(rooms, 'rooms', 'rooms'));
                const data = filterItems(rooms, 'rooms', 'rooms');
                const tbody = document.querySelector('#rooms-table tbody');
                const pager = document.getElementById('rooms-pagination');
                paginate(data, 5, slice => {
                    console.log('Room slice:', slice);
                    tbody.innerHTML = slice.map(r => {
                        const hostel = hostels.find(h => h.id === r.hostelId);
                        const occupied = allocations.filter(a => a.roomId === r.id && a.status === 'Active').length;
                        const status = occupied === 0 ? 'Available' : occupied >= r.capacity ? 'Full' : 'Partially Occupied';
                        return `
                            <tr data-room-id="${r.id}">
                                <td>${r.id}</td>
                                <td>${hostel ? hostel.name : 'N/A'}</td>
                                <td>${r.number}</td>
                                <td>${r.capacity}</td>
                                <td>${occupied}</td>
                                <td><span class="status status-${status.toLowerCase().replace(' ', '-')}">${status}</span></td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-info" data-view="${r.id}" data-type="room"><i class="fas fa-eye"></i> View</button>
                                        <button class="btn btn-sm btn-warning" data-edit="${r.id}" data-type="room"><i class="fas fa-edit"></i> Edit</button>
                                        <button class="btn btn-sm btn-danger" data-delete="${r.id}" data-type="room"><i class="fas fa-trash"></i> Delete</button>
                                        <button class="btn btn-sm btn-success" data-allocate="${r.id}" data-type="room"><i class="fas fa-user-plus"></i> Allocate</button>
                                    </div>
                                </td>
                            </tr>`;
                    }).join('');
                    bindActions();
                }, pager);
            }

            function renderAllocations() {
                console.log('Rendering allocations with data:', filterItems(allocations, 'allocations', 'allocations'));
                const data = filterItems(allocations, 'allocations', 'allocations');
                const tbody = document.querySelector('#allocations-table tbody');
                const pager = document.getElementById('allocations-pagination');
                paginate(data, 5, slice => {
                    console.log('Allocation slice:', slice);
                    tbody.innerHTML = slice.map(a => {
                        const student = students.find(s => s.id === a.studentId);
                        const hostel = hostels.find(h => h.id === a.hostelId);
                        const room = rooms.find(r => r.id === a.roomId);
                        return `
                            <tr data-allocation-id="${a.id}">
                                <td>${a.id}</td>
                                <td>${student ? student.name : 'N/A'}</td>
                                <td>${hostel ? hostel.name : 'N/A'}</td>
                                <td>${room ? room.number : 'N/A'}</td>
                                <td>${a.startDate}</td>
                                <td>${a.endDate}</td>
                                <td><span class="status status-${a.status.toLowerCase()}">${a.status}</span></td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-info" data-view="${a.id}" data-type="allocation"><i class="fas fa-eye"></i> View</button>
                                        <button class="btn btn-sm btn-warning" data-edit="${a.id}" data-type="allocation"><i class="fas fa-edit"></i> Edit</button>
                                        <button class="btn btn-sm btn-danger" data-delete="${a.id}" data-type="allocation"><i class="fas fa-trash"></i> Delete</button>
                                    </div>
                                </td>
                            </tr>`;
                    }).join('');
                    bindActions();
                }, pager);
            }

            // Validate forms
            function validateAccommodationForm() {
                let isValid = true;
                const type = document.getElementById('accommodation-type').value;
                const fields = [
                    { id: 'accommodation-type', errorId: 'accommodation-type-error', condition: val => !val, message: 'Type is required' }
                ];

                if (type === 'hostel') {
                    fields.push(
                        { id: 'hostel-name', errorId: 'hostel-name-error', condition: val => !val.trim(), message: 'Hostel name is required' },
                        { id: 'hostel-capacity', errorId: 'hostel-capacity-error', condition: val => !val || parseInt(val) <= 0, message: 'Capacity must be greater than 0' }
                    );
                } else if (type === 'room') {
                    fields.push(
                        { id: 'room-hostel', errorId: 'room-hostel-error', condition: val => !val, message: 'Hostel is required' },
                        { id: 'room-number', errorId: 'room-number-error', condition: val => !val.trim(), message: 'Room number is required' },
                        { id: 'room-capacity', errorId: 'room-capacity-error', condition: val => !val || parseInt(val) <= 0, message: 'Capacity must be greater than 0' }
                    );
                }

                fields.forEach(field => {
                    const input = document.getElementById(field.id);
                    const error = document.getElementById(field.errorId);
                    const value = input.value;
                    if (field.condition(value)) {
                        input.classList.add('invalid');
                        error.classList.add('show');
                        error.textContent = field.message;
                        isValid = false;
                    } else {
                        input.classList.remove('invalid');
                        error.classList.remove('show');
                    }
                });

                return isValid;
            }

            function validateAllocationForm() {
                let isValid = true;
                const fields = [
                    { id: 'allocate-student', errorId: 'allocate-student-error', condition: val => !val, message: 'Student is required' },
                    { id: 'allocate-hostel', errorId: 'allocate-hostel-error', condition: val => !val, message: 'Hostel is required' },
                    { id: 'allocate-room', errorId: 'allocate-room-error', condition: val => !val, message: 'Room is required' },
                    { id: 'start-date', errorId: 'start-date-error', condition: val => !val, message: 'Start date is required' },
                    { id: 'end-date', errorId: 'end-date-error', condition: val => !val || new Date(val) < new Date(document.getElementById('start-date').value), message: 'End date must be after start date' }
                ];

                const roomId = document.getElementById('allocate-room').value;
                if (roomId) {
                    const room = rooms.find(r => r.id === roomId);
                    const occupied = allocations.filter(a => a.roomId === roomId && a.status === 'Active').length;
                    if (occupied >= room.capacity) {
                        document.getElementById('allocate-room').classList.add('invalid');
                        document.getElementById('allocate-room-error').classList.add('show');
                        document.getElementById('allocate-room-error').textContent = 'Room is full';
                        isValid = false;
                    }
                }

                fields.forEach(field => {
                    const input = document.getElementById(field.id);
                    const error = document.getElementById(field.errorId);
                    const value = input.value;
                    if (field.condition(value)) {
                        input.classList.add('invalid');
                        error.classList.add('show');
                        error.textContent = field.message;
                        isValid = false;
                    } else if (field.id !== 'allocate-room') {
                        input.classList.remove('invalid');
                        error.classList.remove('show');
                    }
                });

                return isValid;
            }

            // Bind actions
            function bindActions() {
                document.querySelectorAll('[data-view]').forEach(btn => {
                    btn.onclick = () => {
                        console.log('Viewing item:', btn.getAttribute('data-view'), btn.getAttribute('data-type'));
                        const id = btn.getAttribute('data-view');
                        const type = btn.getAttribute('data-type');
                        let item;
                        let fields = [];
                        let title = '';
                        if (type === 'hostel') {
                            item = hostels.find(h => h.id === id);
                            const occupied = allocations.filter(a => a.hostelId === id && a.status === 'Active').length;
                            const available = item.capacity - occupied;
                            const status = available === 0 ? 'Full' : available === item.capacity ? 'Available' : 'Partially Occupied';
                            title = 'Hostel Details';
                            fields = [
                                { label: 'Hostel ID', value: item.id },
                                { label: 'Hostel Name', value: item.name },
                                { label: 'Capacity', value: item.capacity },
                                { label: 'Occupied', value: occupied },
                                { label: 'Available', value: available },
                                { label: 'Occupancy Rate', value: `${item.capacity ? ((occupied / item.capacity) * 100).toFixed(1) : 0}%` },
                                { label: 'Status', value: status, class: `status-${status.toLowerCase().replace(' ', '-')}` }
                            ];
                        } else if (type === 'room') {
                            item = rooms.find(r => r.id === id);
                            const hostel = hostels.find(h => h.id === item.hostelId);
                            const occupied = allocations.filter(a => a.roomId === id && a.status === 'Active').length;
                            const status = occupied === 0 ? 'Available' : occupied >= item.capacity ? 'Full' : 'Partially Occupied';
                            title = 'Room Details';
                            fields = [
                                { label: 'Room ID', value: item.id },
                                { label: 'Hostel', value: hostel ? hostel.name : 'N/A' },
                                { label: 'Room Number', value: item.number },
                                { label: 'Capacity', value: item.capacity },
                                { label: 'Occupied', value: occupied },
                                { label: 'Status', value: status, class: `status-${status.toLowerCase().replace(' ', '-')}` }
                            ];
                        } else if (type === 'allocation') {
                            item = allocations.find(a => a.id === id);
                            const student = students.find(s => s.id === item.studentId);
                            const hostel = hostels.find(h => h.id === item.hostelId);
                            const room = rooms.find(r => r.id === item.roomId);
                            title = 'Allocation Details';
                            fields = [
                                { label: 'Allocation ID', value: item.id },
                                { label: 'Student', value: student ? student.name : 'N/A' },
                                { label: 'Hostel', value: hostel ? hostel.name : 'N/A' },
                                { label: 'Room', value: room ? room.number : 'N/A' },
                                { label: 'Start Date', value: item.startDate },
                                { label: 'End Date', value: item.endDate },
                                { label: 'Status', value: item.status, class: `status-${item.status.toLowerCase()}` }
                            ];
                        }
                        document.getElementById('accommodation-modal-title').textContent = title;
                        document.getElementById('accommodation-profile-id').textContent = item.id;
                        document.getElementById('accommodation-profile-name').textContent = type === 'hostel' ? item.name : type === 'room' ? item.number : students.find(s => s.id === item.studentId)?.name || 'N/A';
                        document.getElementById('accommodation-profile-grid').innerHTML = fields.map(f => `
                            <div class="accommodation-item ${f.class || ''}">
                                <label>${f.label}</label>
                                <p>${f.value}</p>
                            </div>
                        `).join('');
                        document.getElementById('edit-btn').style.display = type !== 'allocation' ? 'inline-flex' : 'none';
                        document.getElementById('edit-btn').dataset.editId = type !== 'allocation' ? id : '';
                        document.getElementById('edit-btn').dataset.type = type;
                        document.getElementById('accommodation-details-modal').style.display = 'flex';
                    };
                });

                document.querySelectorAll('[data-edit][data-type="hostel"]').forEach(btn => {
                    btn.onclick = () => {
                        console.log('Editing hostel:', btn.getAttribute('data-edit'));
                        const id = btn.getAttribute('data-edit');
                        const hostel = hostels.find(h => h.id === id);
                        document.getElementById('accommodation-type').value = 'hostel';
                        document.getElementById('hostel-name').value = hostel.name;
                        document.getElementById('hostel-capacity').value = hostel.capacity;
                        document.querySelectorAll('.hostel-field').forEach(f => f.style.display = 'flex');
                        document.querySelectorAll('.room-field').forEach(f => f.style.display = 'none');
                        document.getElementById('accommodation-form').dataset.editId = id;
                        document.getElementById('accommodation-form').dataset.editType = 'hostel';
                        document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
                        document.querySelectorAll('.form-control').forEach(el => el.classList.remove('invalid'));
                        document.getElementById('add-accommodation-section').classList.add('show');
                        document.getElementById('add-accommodation-section').scrollIntoView({ behavior: 'smooth' });
                    };
                });

                document.querySelectorAll('[data-edit][data-type="room"]').forEach(btn => {
                    btn.onclick = () => {
                        console.log('Editing room:', btn.getAttribute('data-edit'));
                        const id = btn.getAttribute('data-edit');
                        const room = rooms.find(r => r.id === id);
                        document.getElementById('accommodation-type').value = 'room';
                        document.getElementById('room-hostel').value = room.hostelId;
                        document.getElementById('room-number').value = room.number;
                        document.getElementById('room-capacity').value = room.capacity;
                        document.querySelectorAll('.hostel-field').forEach(f => f.style.display = 'none');
                        document.querySelectorAll('.room-field').forEach(f => f.style.display = 'flex');
                        document.getElementById('accommodation-form').dataset.editId = id;
                        document.getElementById('accommodation-form').dataset.editType = 'room';
                        document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
                        document.querySelectorAll('.form-control').forEach(el => el.classList.remove('invalid'));
                        document.getElementById('add-accommodation-section').classList.add('show');
                        document.getElementById('add-accommodation-section').scrollIntoView({ behavior: 'smooth' });
                    };
                });

                document.querySelectorAll('[data-edit][data-type="allocation"]').forEach(btn => {
                    btn.onclick = () => {
                        console.log('Editing allocation:', btn.getAttribute('data-edit'));
                        const id = btn.getAttribute('data-edit');
                        const allocation = allocations.find(a => a.id === id);
                        document.getElementById('allocate-student').value = allocation.studentId;
                        document.getElementById('allocate-hostel').value = allocation.hostelId;
                        document.getElementById('allocate-room').value = allocation.roomId;
                        document.getElementById('start-date').value = allocation.startDate;
                        document.getElementById('end-date').value = allocation.endDate;
                        document.getElementById('allocation-form').dataset.editId = id;
                        updateRoomOptions();
                        document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
                        document.querySelectorAll('.form-control').forEach(el => el.classList.remove('invalid'));
                        document.getElementById('allocate-room-section').classList.add('show');
                        document.getElementById('allocate-room-section').scrollIntoView({ behavior: 'smooth' });
                    };
                });

                document.querySelectorAll('[data-delete][data-type="hostel"]').forEach(btn => {
                    btn.onclick = () => {
                        console.log('Deleting hostel:', btn.getAttribute('data-delete'));
                        const id = btn.getAttribute('data-delete');
                        if (rooms.some(r => r.hostelId === id) || allocations.some(a => a.hostelId === id)) {
                            alert('Cannot delete hostel with associated rooms or allocations');
                            return;
                        }
                        hostels = hostels.filter(h => h.id !== id);
                        renderHostels();
                        updateKPIs();
                        populateDropdowns();
                        alert('Hostel deleted successfully');
                    };
                });

                document.querySelectorAll('[data-delete][data-type="room"]').forEach(btn => {
                    btn.onclick = () => {
                        console.log('Deleting room:', btn.getAttribute('data-delete'));
                        const id = btn.getAttribute('data-delete');
                        if (allocations.some(a => a.roomId === id)) {
                            alert('Cannot delete room with active allocations');
                            return;
                        }
                        rooms = rooms.filter(r => r.id !== id);
                        renderRooms();
                        updateKPIs();
                        populateDropdowns();
                        alert('Room deleted successfully');
                    };
                });

                document.querySelectorAll('[data-delete][data-type="allocation"]').forEach(btn => {
                    btn.onclick = () => {
                        console.log('Deleting allocation:', btn.getAttribute('data-delete'));
                        const id = btn.getAttribute('data-delete');
                        allocations = allocations.filter(a => a.id !== id);
                        renderAllocations();
                        renderHostels();
                        renderRooms();
                        updateKPIs();
                        alert('Allocation deleted successfully');
                    };
                });

                document.querySelectorAll('[data-allocate][data-type="room"]').forEach(btn => {
                    btn.onclick = () => {
                        console.log('Allocating room:', btn.getAttribute('data-allocate'));
                        const id = btn.getAttribute('data-allocate');
                        const room = rooms.find(r => r.id === id);
                        document.getElementById('allocate-hostel').value = room.hostelId;
                        document.getElementById('allocate-room').value = id;
                        document.getElementById('allocate-student').value = '';
                        document.getElementById('start-date').value = '';
                        document.getElementById('end-date').value = '';
                        document.getElementById('allocation-form').dataset.editId = '';
                        updateRoomOptions();
                        document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
                        document.querySelectorAll('.form-control').forEach(el => el.classList.remove('invalid'));
                        document.getElementById('allocate-room-section').classList.add('show');
                        document.getElementById('allocate-room-section').scrollIntoView({ behavior: 'smooth' });
                    };
                });
            }

            // Update room options based on hostel
            function updateRoomOptions() {
                console.log('Updating room options for hostel:', document.getElementById('allocate-hostel').value);
                const hostelId = document.getElementById('allocate-hostel').value;
                const roomSelect = document.getElementById('allocate-room');
                roomSelect.innerHTML = '<option value="">Select Room</option>';
                rooms.filter(r => !hostelId || r.hostelId === hostelId).forEach(r => {
                    const option = document.createElement('option');
                    option.value = r.id;
                    option.textContent = `${r.number} (${hostels.find(h => h.id === r.hostelId)?.name || 'N/A'})`;
                    option.dataset.hostelId = r.hostelId;
                    roomSelect.appendChild(option);
                });
            }

            // Event Listeners
            document.getElementById('toggle-sidebar').addEventListener('click', () => {
                console.log('Toggling sidebar');
                document.getElementById('sidebar').classList.toggle('collapsed');
                document.getElementById('main-content').classList.toggle('collapsed');
            });

            document.getElementById('add-accommodation-btn').onclick = () => {
                console.log('Opening add accommodation section');
                document.getElementById('accommodation-form').reset();
                document.getElementById('accommodation-form').dataset.editId = '';
                document.getElementById('accommodation-form').dataset.editType = '';
                document.querySelectorAll('.hostel-field').forEach(f => f.style.display = 'flex');
                document.querySelectorAll('.room-field').forEach(f => f.style.display = 'none');
                document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
                document.querySelectorAll('.form-control').forEach(el => el.classList.remove('invalid'));
                document.getElementById('add-accommodation-section').classList.add('show');
                document.getElementById('add-accommodation-section').scrollIntoView({ behavior: 'smooth' });
            };

            document.getElementById('allocate-room-btn').onclick = () => {
                console.log('Opening allocate room section');
                document.getElementById('allocation-form').reset();
                document.getElementById('allocation-form').dataset.editId = '';
                updateRoomOptions();
                document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
                document.querySelectorAll('.form-control').forEach(el => el.classList.remove('invalid'));
                document.getElementById('allocate-room-section').classList.add('show');
                document.getElementById('allocate-room-section').scrollIntoView({ behavior: 'smooth' });
            };

            document.getElementById('cancel-accommodation-btn').onclick = () => {
                console.log('Canceling accommodation form');
                document.getElementById('add-accommodation-section').classList.remove('show');
                document.getElementById('accommodation-form').reset();
                document.getElementById('accommodation-form').dataset.editId = '';
                document.getElementById('accommodation-form').dataset.editType = '';
                document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
                document.querySelectorAll('.form-control').forEach(el => el.classList.remove('invalid'));
            };

            document.getElementById('cancel-allocation-btn').onclick = () => {
                console.log('Canceling allocation form');
                document.getElementById('allocate-room-section').classList.remove('show');
                document.getElementById('allocation-form').reset();
                document.getElementById('allocation-form').dataset.editId = '';
                document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
                document.querySelectorAll('.form-control').forEach(el => el.classList.remove('invalid'));
            };

            document.getElementById('accommodation-details-close').onclick = () => {
                console.log('Closing details modal');
                document.getElementById('accommodation-details-modal').style.display = 'none';
            };

            document.getElementById('details-close-btn').onclick = () => {
                console.log('Closing details modal via button');
                document.getElementById('accommodation-details-modal').style.display = 'none';
            };

            document.getElementById('print-btn').onclick = () => {
    console.log('Printing accommodation details');
    const content = document.querySelector('.accommodation-profile').outerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Accommodation Details</title>
                <style>
                    body { font-family: 'Delius', 'Segoe UI', sans-serif; padding: 20px; }
                    .accommodation-profile { max-width: 800px; margin: auto; }
                    .accommodation-header { background: linear-gradient(135deg, #4A90E2, #2E6DA4); color: #fff; padding: 12px 16px; border-radius: 8px 8px 0 0; display: flex; align-items: center; gap: 12px; }
                    .accommodation-icon { width: 60px; height: 60px; border-radius: 50%; background: #f8f9fa; display: grid; place-items: center; font-size: 2rem; color: #4A90E2; border: 2px solid #fff; }
                    .accommodation-title { font-size: 1.2rem; font-weight: 700; }
                    .accommodation-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 16px; }
                    .accommodation-item label { font-weight: 600; color: #212529; font-size: 0.95rem; }
                    .accommodation-item p { color: #6c757d; font-size: 0.9rem; background: #f8f9fa; padding: 8px; border-radius: 6px; margin: 0; }
                    .accommodation-item.status-available p, .accommodation-item.status-active p { color: #28a745; font-weight: 600; }
                    .accommodation-item.status-partially-occupied p, .accommodation-item.status-pending p { color: #a56a00; font-weight: 600; }
                    .accommodation-item.status-full p { color: #dc3545; font-weight: 600; }
                </style>
            </head>
            <body>
                ${content}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
};

document.getElementById('edit-btn').onclick = () => {
    console.log('Editing from modal:', document.getElementById('edit-btn').dataset);
    const id = document.getElementById('edit-btn').dataset.editId;
    const type = document.getElementById('edit-btn').dataset.type;
    if (type === 'hostel') {
        const hostel = hostels.find(h => h.id === id);
        document.getElementById('accommodation-type').value = 'hostel';
        document.getElementById('hostel-name').value = hostel.name;
        document.getElementById('hostel-capacity').value = hostel.capacity;
        document.querySelectorAll('.hostel-field').forEach(f => f.style.display = 'flex');
        document.querySelectorAll('.room-field').forEach(f => f.style.display = 'none');
        document.getElementById('accommodation-form').dataset.editId = id;
        document.getElementById('accommodation-form').dataset.editType = 'hostel';
    } else if (type === 'room') {
        const room = rooms.find(r => r.id === id);
        document.getElementById('accommodation-type').value = 'room';
        document.getElementById('room-hostel').value = room.hostelId;
        document.getElementById('room-number').value = room.number;
        document.getElementById('room-capacity').value = room.capacity;
        document.querySelectorAll('.hostel-field').forEach(f => f.style.display = 'none');
        document.querySelectorAll('.room-field').forEach(f => f.style.display = 'flex');
        document.getElementById('accommodation-form').dataset.editId = id;
        document.getElementById('accommodation-form').dataset.editType = 'room';
    }
    document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
    document.querySelectorAll('.form-control').forEach(el => el.classList.remove('invalid'));
    document.getElementById('add-accommodation-section').classList.add('show');
    document.getElementById('accommodation-details-modal').style.display = 'none';
    document.getElementById('add-accommodation-section').scrollIntoView({ behavior: 'smooth' });
};

document.getElementById('accommodation-type').onchange = () => {
    console.log('Accommodation type changed to:', document.getElementById('accommodation-type').value);
    const type = document.getElementById('accommodation-type').value;
    document.querySelectorAll('.hostel-field').forEach(f => f.style.display = type === 'hostel' ? 'flex' : 'none');
    document.querySelectorAll('.room-field').forEach(f => f.style.display = type === 'room' ? 'flex' : 'none');
    document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
    document.querySelectorAll('.form-control').forEach(el => el.classList.remove('invalid'));
};

document.getElementById('allocate-hostel').onchange = updateRoomOptions;

document.getElementById('accommodation-form').onsubmit = async e => {
    e.preventDefault();
    if (!validateAccommodationForm()) return;
    const saveBtn = document.getElementById('save-accommodation-btn');
    saveBtn.disabled = true;
    saveBtn.classList.add('btn-loading');
    const type = document.getElementById('accommodation-type').value;
    const editId = document.getElementById('accommodation-form').dataset.editId;
    console.log('Saving accommodation:', { type, editId });
    await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate async save
    if (type === 'hostel') {
        const hostel = {
            id: editId || `HST${String(hostels.length + 1).padStart(3, '0')}`,
            name: document.getElementById('hostel-name').value,
            capacity: parseInt(document.getElementById('hostel-capacity').value)
        };
        if (editId) {
            hostels = hostels.map(h => h.id === editId ? hostel : h);
        } else {
            hostels.push(hostel);
        }
    } else if (type === 'room') {
        const room = {
            id: editId || `RM${String(rooms.length + 1).padStart(3, '0')}`,
            hostelId: document.getElementById('room-hostel').value,
            number: document.getElementById('room-number').value,
            capacity: parseInt(document.getElementById('room-capacity').value)
        };
        if (editId) {
            rooms = rooms.map(r => r.id === editId ? room : r);
        } else {
            rooms.push(room);
        }
    }
    saveBtn.disabled = false;
    saveBtn.classList.remove('btn-loading');
    document.getElementById('add-accommodation-section').classList.remove('show');
    document.getElementById('accommodation-form').reset();
    document.getElementById('accommodation-form').dataset.editId = '';
    document.getElementById('accommodation-form').dataset.editType = '';
    renderHostels();
    renderRooms();
    updateKPIs();
    populateDropdowns();
    alert(`Successfully ${editId ? 'updated' : 'added'} ${type}`);
};

document.getElementById('allocation-form').onsubmit = async e => {
    e.preventDefault();
    if (!validateAllocationForm()) return;
    const saveBtn = document.getElementById('save-allocation-btn');
    saveBtn.disabled = true;
    saveBtn.classList.add('btn-loading');
    const editId = document.getElementById('allocation-form').dataset.editId;
    console.log('Saving allocation:', { editId });
    await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate async save
    const allocation = {
        id: editId || `ALC${String(allocations.length + 1).padStart(3, '0')}`,
        studentId: document.getElementById('allocate-student').value,
        hostelId: document.getElementById('allocate-hostel').value,
        roomId: document.getElementById('allocate-room').value,
        startDate: document.getElementById('start-date').value,
        endDate: document.getElementById('end-date').value,
        status: 'Active'
    };
    if (editId) {
        allocations = allocations.map(a => a.id === editId ? allocation : a);
    } else {
        allocations.push(allocation);
    }
    saveBtn.disabled = false;
    saveBtn.classList.remove('btn-loading');
    document.getElementById('allocate-room-section').classList.remove('show');
    document.getElementById('allocation-form').reset();
    document.getElementById('allocation-form').dataset.editId = '';
    renderAllocations();
    renderHostels();
    renderRooms();
    updateKPIs();
    alert(`Successfully ${editId ? 'updated' : 'allocated'} room`);
};

document.getElementById('hostels-apply-filters').onclick = () => {
    console.log('Applying hostel filters');
    renderHostels();
};

document.getElementById('hostels-reset-filters').onclick = () => {
    console.log('Resetting hostel filters');
    document.getElementById('hostels-hostel-filter').value = '';
    document.getElementById('hostels-status-filter').value = '';
    document.getElementById('hostels-date-range-filter').value = '';
    document.getElementById('hostels-search').value = '';
    renderHostels();
};

document.getElementById('rooms-apply-filters').onclick = () => {
    console.log('Applying room filters');
    renderRooms();
};

document.getElementById('rooms-reset-filters').onclick = () => {
    console.log('Resetting room filters');
    document.getElementById('rooms-hostel-filter').value = '';
    document.getElementById('rooms-status-filter').value = '';
    document.getElementById('rooms-date-range-filter').value = '';
    document.getElementById('rooms-search').value = '';
    renderRooms();
};

document.getElementById('allocations-apply-filters').onclick = () => {
    console.log('Applying allocation filters');
    renderAllocations();
};

document.getElementById('allocations-reset-filters').onclick = () => {
    console.log('Resetting allocation filters');
    document.getElementById('allocations-hostel-filter').value = '';
    document.getElementById('allocations-status-filter').value = '';
    document.getElementById('allocations-student-filter').value = '';
    document.getElementById('allocations-date-range-filter').value = '';
    document.getElementById('allocations-search').value = '';
    renderAllocations();
};

document.querySelectorAll('.tab').forEach(tab => {
    tab.onclick = () => {
        console.log('Switching to tab:', tab.dataset.tab);
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        tab.classList.add('active');
        document.getElementById(`${tab.dataset.tab}-tab`).style.display = 'block';
        if (tab.dataset.tab === 'hostels') renderHostels();
        else if (tab.dataset.tab === 'rooms') renderRooms();
        else if (tab.dataset.tab === 'allocations') renderAllocations();
    };
});

// Initialize
console.log('Initializing dashboard');
populateDropdowns();
updateKPIs();
renderHostels();
});
</script>
</body>
</html>